        <!DOCTYPE html>
        <html>
        <head>
                <meta charset="utf-8">
        <title>SimpleJsonFormat class / serialization Library / Dart API Reference</title>
        <link rel="stylesheet" type="text/css"
            href="../styles.css">
        <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800" rel="stylesheet" type="text/css">
        <link rel="shortcut icon" href="../favicon.ico">
        
        <link rel="stylesheet" type="text/css"
            href="../apidoc-styles.css" />
        
        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(["_setAccount", "UA-26406144-9"]);
          _gaq.push(["_trackPageview"]);

          (function() {
            var ga = document.createElement("script");
            ga.type = "text/javascript"; ga.async = true;
            ga.src = ("https:" == document.location.protocol ?
              "https://ssl" : "http://www") + ".google-analytics.com/ga.js";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(ga, s);
          })();
        </script>
        
        </head>
        <body data-library="serialization" data-type="SimpleJsonFormat">
        <div class="page">
        <div class="header">
          <a href="http://dartlang.org" ref="external"><div class="logo"></div></a>
          <a href="../index.html">Dart API Reference</a>
         &rsaquo; <a href="../serialization.html">serialization</a> &rsaquo; <a href="../serialization/SimpleJsonFormat.html">SimpleJsonFormat</a>        <form action="http://www.dartlang.org/search.html" id="search-box">
          <input type="hidden" name="cx" value="011220921317074318178:i4mscbaxtru">
          <input type="hidden" name="ie" value="UTF-8">
          <input type="hidden" name="hl" value="en">
          <input type="search" name="q" id="q" autocomplete="off"
              class="search-input" placeholder="Search API">
        </form>
        
      </div>
      <div class="drop-down" id="drop-down"></div>
      
        <div class="nav">
        
<h2><div class="icon-library"></div><a href="../args.html">args</a></h2><h2><div class="icon-library"></div><a href="../dart_async.html">dart:async</a></h2><h2><div class="icon-library"></div><a href="../dart_chrome.html">dart:chrome</a></h2><h2><div class="icon-library"></div><a href="../dart_collection.html">dart:collection</a></h2><h2><div class="icon-library"></div><a href="../dart_core.html">dart:core</a></h2><h2><div class="icon-library"></div><a href="../dart_crypto.html">dart:crypto</a></h2><h2><div class="icon-library"></div><a href="../dart_html.html">dart:html</a></h2><h2><div class="icon-library"></div><a href="../dart_indexed_db.html">dart:indexed_db</a></h2><h2><div class="icon-library"></div><a href="../dart_io.html">dart:io</a></h2><h2><div class="icon-library"></div><a href="../dart_isolate.html">dart:isolate</a></h2><h2><div class="icon-library"></div><a href="../dart_json.html">dart:json</a></h2><h2><div class="icon-library"></div><a href="../dart_math.html">dart:math</a></h2><h2><div class="icon-library"></div><a href="../dart_mirrors.html">dart:mirrors</a></h2><h2><div class="icon-library"></div><a href="../dart_scalarlist.html">dart:scalarlist</a></h2><h2><div class="icon-library"></div><a href="../dart_svg.html">dart:svg</a></h2><h2><div class="icon-library"></div><a href="../dart_uri.html">dart:uri</a></h2><h2><div class="icon-library"></div><a href="../dart_utf.html">dart:utf</a></h2><h2><div class="icon-library"></div><a href="../dart_web_audio.html">dart:web_audio</a></h2><h2><div class="icon-library"></div><a href="../dart_web_sql.html">dart:web_sql</a></h2><h2><div class="icon-library"></div><a href="../fixnum.html">fixnum</a></h2><h2><div class="icon-library"></div><a href="../intl.html">intl</a></h2><h2><div class="icon-library"></div><a href="../logging.html">logging</a></h2><h2><div class="icon-library"></div><a href="../matcher.html">matcher</a></h2><h2><div class="icon-library"></div><a href="../meta.html">meta</a></h2><h2><div class="icon-library"></div><a href="../mock.html">mock</a></h2><h2><div class="icon-library"></div><a href="../scheduled_test.html">scheduled_test</a></h2><h2><div class="icon-library"></div><a href="../serialization.html">serialization</a></h2><ul class="icon">
<li><a href="../serialization/BasicRule.html"><div class="icon-class"></div>BasicRule</a></li>
<li><a href="../serialization/ClosureRule.html"><div class="icon-class"></div>ClosureRule</a></li>
<li><a href="../serialization/Constructor.html"><div class="icon-class"></div>Constructor</a></li>
<li><a href="../serialization/ConstructType.html"><div class="icon-interface"></div>ConstructType</a></li>
<li><a href="../serialization/CustomRule.html"><div class="icon-class"></div>CustomRule</a></li>
<li><a href="../serialization/DesignatedRuleForObject.html"><div class="icon-class"></div>DesignatedRuleForObject</a></li>
<li><a href="../serialization/Format.html"><div class="icon-class"></div>Format</a></li>
<li><a href="../serialization/GetStateType.html"><div class="icon-interface"></div>GetStateType</a></li>
<li><a href="../serialization/ListRule.html"><div class="icon-class"></div>ListRule</a></li>
<li><a href="../serialization/ListRuleEssential.html"><div class="icon-class"></div>ListRuleEssential</a></li>
<li><a href="../serialization/MapRule.html"><div class="icon-class"></div>MapRule</a></li>
<li><a href="../serialization/MirrorRule.html"><div class="icon-class"></div>MirrorRule</a></li>
<li><a href="../serialization/NamedObjectRule.html"><div class="icon-class"></div>NamedObjectRule</a></li>
<li><a href="../serialization/NonEssentialStateType.html"><div class="icon-interface"></div>NonEssentialStateType</a></li>
<li><a href="../serialization/PrimitiveRule.html"><div class="icon-class"></div>PrimitiveRule</a></li>
<li><a href="../serialization/Reader.html"><div class="icon-class"></div>Reader</a></li>
<li><a href="../serialization/ReaderOrWriter.html"><div class="icon-class"></div>ReaderOrWriter</a></li>
<li><a href="../serialization/Reference.html"><div class="icon-class"></div>Reference</a></li>
<li><a href="../serialization/Serialization.html"><div class="icon-class"></div>Serialization</a></li>
<li><a href="../serialization/SerializationRule.html"><div class="icon-class"></div>SerializationRule</a></li>
<li><a href="../serialization/SetWithFunction.html"><div class="icon-interface"></div>SetWithFunction</a></li>
<li><a href="../serialization/SimpleFlatFormat.html"><div class="icon-class"></div>SimpleFlatFormat</a></li>
<li><div class="icon-class"></div><strong>SimpleJsonFormat</strong></li>
<li><a href="../serialization/SimpleMapFormat.html"><div class="icon-class"></div>SimpleMapFormat</a></li>
<li><a href="../serialization/Trace.html"><div class="icon-class"></div>Trace</a></li>
<li><a href="../serialization/Writer.html"><div class="icon-class"></div>Writer</a></li>
<li><a href="../serialization/SerializationException.html"><div class="icon-exception"></div>SerializationException</a></li>
</ul>
<h2><div class="icon-library"></div><a href="../unittest.html">unittest</a></h2></div>
<div class="content">
        <h2><strong>SimpleJsonFormat</strong>
          class
        </h2>
        
<button id="show-inherited" class="show-inherited">Hide inherited</button>
<div class="doc">
<p>A format for "normal" <code>json</code> representation of objects. It stores
the fields of the objects as nested maps, and doesn't allow cycles. This can
be useful in talking to existing APIs that expect <code>json</code> format data. The
output will be either a simple object (string, num, bool), a List, or a Map,
with nesting of those.
Note that since the classes of objects aren't normally stored, this isn't
enough information to read back the objects. However, if the
If the <code>storeRoundTripData</code> field of the format is set to true, then this
will store the rule number along with the data, allowing reconstruction.</p>
<pre class="source">
class SimpleJsonFormat extends Format {

 /**
  * Indicate if we should store rule numbers with map/list data so that we
  * will know how to reconstruct it with a read operation. If we don't, this
  * will be more compliant with things that expect known format JSON as input,
  * but we won't be able to read back the objects.
  */
 final bool storeRoundTripInfo;

 /**
  * If we store the rule numbers, what key should we use to store them.
  */
 static final String RULE = "_rule";
 static final String RULES = "_rules";
 static final String DATA = "_data";
 static final String ROOTS = "_root";

 SimpleJsonFormat({this.storeRoundTripInfo : false});

 /**
  * Generate output for this format from [w] and return it as
  * the [json] representation of a nested Map structure.
  */
 generateOutput(Writer w) {
   jsonify(w);
   var root = w._rootReferences().first;
   if (root is Reference) root = w.stateForReference(root);
   if (w.selfDescribing &amp;&amp; storeRoundTripInfo) {
     root = new Map()
         ..[RULES] = w.serializedRules()
         ..[DATA] = root;
   }
   return root;
 }

 /**
  * Convert the data generated by the rules to have nested maps instead
  * of Reference objects and to add rule numbers if [storeRoundTripInfo]
  * is true.
  */
 jsonify(Writer w) {
   for (var eachRule in w.rules) {
     var ruleData = w.states[eachRule.number];
     jsonifyForRule(ruleData, w, eachRule);
   }
 }

 /**
  * For a particular [rule] modify the [ruleData] to conform to this format.
  */
 jsonifyForRule(List ruleData, Writer w, SerializationRule rule) {
   for (var i = 0; i &lt; ruleData.length; i++) {
     var each = ruleData[i];
     if (each is List) {
       jsonifyEntry(each, w);
       if (storeRoundTripInfo) ruleData[i].add(rule.number);
     } else if (each is Map) {
       jsonifyEntry(each, w);
       if (storeRoundTripInfo) each[RULE] = rule.number;
     }
   }
 }

 /**
  * For one particular entry, which is either a Map or a List, update it
  * to turn References into a nested List/Map.
  */
 jsonifyEntry(map, Writer w) {
   // Note, if this is a Map, and the key might be a reference, we need to
   // bend over backwards to avoid concurrent modifications. Non-string keys
   // won't actually work if we try to write this to json, but might happen
   // if e.g. sending between isolates.
   var updates = new Map();
   keysAndValues(map).forEach((key, value) {
     if (value is Reference) updates[key] = w.stateForReference(value);
   });
   updates.forEach((k, v) =&gt; map[k] = v);
 }

 /**
  * Read serialized data saved in this format, which should look like
  * either a simple type, a List or a Map and return the Map
  * representation that the reader expects, with top-level
  * entries for "rules", "data", and "roots". Nested lists/maps will be
  * converted into Reference objects. Note that if the data was not written
  * with [storeRoundTripInfo] true this will fail.
  */
 Map&lt;String, dynamic&gt; read(data, Reader reader) {
   var result = new Map();
   // Check the case of having been written without additional data and
   // read as if it had been written with storeRoundTripData set.
   if (reader.selfDescribing &amp;&amp; !(data.containsKey(DATA))) {
     throw new SerializationException("Missing $DATA entry, "
         "may mean this was written and read with different values "
         "of selfDescribing.");
   }
   // If we are self-describing, we should have separate rule and data
   // sections. If not, we assume that we have just the data at the top level.
   var rules = reader.selfDescribing ? data[RULES] : null;
   var actualData = reader.selfDescribing ? data[DATA] : data;
   reader.readRules(rules);
   var ruleData = new List(reader.rules.length).map((x) =&gt; []).toList();
   var top = recursivelyFixUp(actualData, reader, ruleData);
   result["data"] = ruleData;
   result["roots"] = [top];
   return result;
 }

 /**
  * Convert nested references in [data] into [Reference] objects.
  */
 recursivelyFixUp(input, Reader r, List result) {
   var data = input;
   if (isPrimitive(data)) {
     result[r._primitiveRule().number].add(data);
     return data;
   }
   var ruleNumber;
   // If we've added the rule number on as the last item in a list we have
   // to get rid of it or it will be interpreted as extra data. For a map
   // the library will be ok, but we need to get rid of the extra key before
   // the data is shown to the user, so we destructively modify.
   if (data is List) {
     ruleNumber = data.last;
     data = data.take(data.length - 1).toList();
   } else if (data is Map) {
     ruleNumber = data.remove(RULE);
   } else {
     throw new SerializationException("Invalid data format");
   }
   // Do not use map or other lazy operations for this. They do not play
   // well with a function that destructively modifies its arguments.
   var newData = mapValues(data, (each) =&gt; recursivelyFixUp(each, r, result));
   result[ruleNumber].add(newData);
   return new Reference(r, ruleNumber, result[ruleNumber].length - 1);
 }
}
</pre>
</div>
<h3>Extends</h3>
<p>
<span class="type-box"><span class="icon-class"></span><a href="../serialization/Format.html">Format</a></span>&nbsp;&gt;&nbsp;<span class="type-box"><span class="icon-class"></span><strong>SimpleJsonFormat</strong></span></p>
<div>
<h3>Static Properties</h3>
<div class="field"><h4 id="DATA">
<button class="show-code">Code</button>
final <a href="../dart_core/String.html">String</a>         <strong>DATA</strong> <a class="anchor-link"
            href="#DATA"
            title="Permalink to SimpleJsonFormat.DATA">#</a>
        </h4>
        <div class="doc">
<pre class="source">
DATA = "_data"
</pre>
</div>
</div>
<div class="field"><h4 id="ROOTS">
<button class="show-code">Code</button>
final <a href="../dart_core/String.html">String</a>         <strong>ROOTS</strong> <a class="anchor-link"
            href="#ROOTS"
            title="Permalink to SimpleJsonFormat.ROOTS">#</a>
        </h4>
        <div class="doc">
<pre class="source">
ROOTS = "_root"
</pre>
</div>
</div>
<div class="field"><h4 id="RULE">
<button class="show-code">Code</button>
final <a href="../dart_core/String.html">String</a>         <strong>RULE</strong> <a class="anchor-link"
            href="#RULE"
            title="Permalink to SimpleJsonFormat.RULE">#</a>
        </h4>
        <div class="doc">
<pre class="source">
RULE = "_rule"
</pre>
</div>
</div>
<div class="field"><h4 id="RULES">
<button class="show-code">Code</button>
final <a href="../dart_core/String.html">String</a>         <strong>RULES</strong> <a class="anchor-link"
            href="#RULES"
            title="Permalink to SimpleJsonFormat.RULES">#</a>
        </h4>
        <div class="doc">
<pre class="source">
RULES = "_rules"
</pre>
</div>
</div>
</div>
<div>
<h3>Constructors</h3>
<div class="method"><h4 id="SimpleJsonFormat">
<button class="show-code">Code</button>
new <strong>SimpleJsonFormat</strong>({<a href="../dart_core/bool.html">bool</a> storeRoundTripInfo: false}) <a class="anchor-link" href="#SimpleJsonFormat"
              title="Permalink to SimpleJsonFormat.SimpleJsonFormat">#</a></h4>
<div class="doc">
<pre class="source">
SimpleJsonFormat({this.storeRoundTripInfo : false});
</pre>
</div>
</div>
</div>
<div>
<h3>Properties</h3>
<div class="field inherited"><h4 id="shouldUseReferencesForPrimitives">
<button class="show-code">Code</button>
final <a href="../dart_core/bool.html">bool</a>         <strong>shouldUseReferencesForPrimitives</strong> <a class="anchor-link"
            href="#shouldUseReferencesForPrimitives"
            title="Permalink to SimpleJsonFormat.shouldUseReferencesForPrimitives">#</a>
        </h4>
        <div class="inherited-from">inherited from <a href="../serialization/Format.html">Format</a> </div><div class="doc">
<p>Return true if this format stores primitives in their own area and uses
references to them (e.g. <a class="crossref" href="../serialization/SimpleFlatFormat.html">SimpleFlatFormat</a>) and false if primitives
are stored directly (e.g. <a class="crossref" href="../serialization/SimpleJsonFormat.html#SimpleJsonFormat">SimpleJsonFormat</a>, <a class="crossref" href="../serialization/SimpleMapFormat.html">SimpleMapFormat</a>).</p>
<pre class="source">
bool get shouldUseReferencesForPrimitives =&gt; false;
</pre>
</div>
</div>
<div class="field"><h4 id="storeRoundTripInfo">
<button class="show-code">Code</button>
final <a href="../dart_core/bool.html">bool</a>         <strong>storeRoundTripInfo</strong> <a class="anchor-link"
            href="#storeRoundTripInfo"
            title="Permalink to SimpleJsonFormat.storeRoundTripInfo">#</a>
        </h4>
        <div class="doc">
<pre class="source">
storeRoundTripInfo
</pre>
</div>
</div>
</div>
<div>
<h3>Methods</h3>
<div class="method"><h4 id="generateOutput">
<button class="show-code">Code</button>
<strong>generateOutput</strong>(<a href="../serialization/Writer.html">Writer</a> w) <a class="anchor-link" href="#generateOutput"
              title="Permalink to SimpleJsonFormat.generateOutput">#</a></h4>
<div class="doc">
<p>Generate output for this format from 
<span class="param">w</span> and return it as
the <code>json</code> representation of a nested Map structure.</p>
<pre class="source">
generateOutput(Writer w) {
 jsonify(w);
 var root = w._rootReferences().first;
 if (root is Reference) root = w.stateForReference(root);
 if (w.selfDescribing &amp;&amp; storeRoundTripInfo) {
   root = new Map()
       ..[RULES] = w.serializedRules()
       ..[DATA] = root;
 }
 return root;
}
</pre>
</div>
</div>
<div class="method"><h4 id="jsonify">
<button class="show-code">Code</button>
<strong>jsonify</strong>(<a href="../serialization/Writer.html">Writer</a> w) <a class="anchor-link" href="#jsonify"
              title="Permalink to SimpleJsonFormat.jsonify">#</a></h4>
<div class="doc">
<p>Convert the data generated by the rules to have nested maps instead
of Reference objects and to add rule numbers if <a class="crossref" href="../serialization/SimpleJsonFormat.html#storeRoundTripInfo">storeRoundTripInfo</a>
is true.</p>
<pre class="source">
jsonify(Writer w) {
 for (var eachRule in w.rules) {
   var ruleData = w.states[eachRule.number];
   jsonifyForRule(ruleData, w, eachRule);
 }
}
</pre>
</div>
</div>
<div class="method"><h4 id="jsonifyEntry">
<button class="show-code">Code</button>
<strong>jsonifyEntry</strong>(map, <a href="../serialization/Writer.html">Writer</a> w) <a class="anchor-link" href="#jsonifyEntry"
              title="Permalink to SimpleJsonFormat.jsonifyEntry">#</a></h4>
<div class="doc">
<p>For one particular entry, which is either a Map or a List, update it
to turn References into a nested List/Map.</p>
<pre class="source">
jsonifyEntry(map, Writer w) {
 // Note, if this is a Map, and the key might be a reference, we need to
 // bend over backwards to avoid concurrent modifications. Non-string keys
 // won't actually work if we try to write this to json, but might happen
 // if e.g. sending between isolates.
 var updates = new Map();
 keysAndValues(map).forEach((key, value) {
   if (value is Reference) updates[key] = w.stateForReference(value);
 });
 updates.forEach((k, v) =&gt; map[k] = v);
}
</pre>
</div>
</div>
<div class="method"><h4 id="jsonifyForRule">
<button class="show-code">Code</button>
<strong>jsonifyForRule</strong>(<a href="../dart_core/List.html">List</a> ruleData, <a href="../serialization/Writer.html">Writer</a> w, <a href="../serialization/SerializationRule.html">SerializationRule</a> rule) <a class="anchor-link" href="#jsonifyForRule"
              title="Permalink to SimpleJsonFormat.jsonifyForRule">#</a></h4>
<div class="doc">
<p>For a particular 
<span class="param">rule</span> modify the 
<span class="param">ruleData</span> to conform to this format.</p>
<pre class="source">
jsonifyForRule(List ruleData, Writer w, SerializationRule rule) {
 for (var i = 0; i &lt; ruleData.length; i++) {
   var each = ruleData[i];
   if (each is List) {
     jsonifyEntry(each, w);
     if (storeRoundTripInfo) ruleData[i].add(rule.number);
   } else if (each is Map) {
     jsonifyEntry(each, w);
     if (storeRoundTripInfo) each[RULE] = rule.number;
   }
 }
}
</pre>
</div>
</div>
<div class="method"><h4 id="read">
<button class="show-code">Code</button>
<a href="../dart_core/Map.html">Map</a>&lt;<a href="../dart_core/String.html">String</a>, dynamic&gt; <strong>read</strong>(data, <a href="../serialization/Reader.html">Reader</a> reader) <a class="anchor-link" href="#read"
              title="Permalink to SimpleJsonFormat.read">#</a></h4>
<div class="doc">
<p>Read serialized data saved in this format, which should look like
either a simple type, a List or a Map and return the Map
representation that the reader expects, with top-level
entries for "rules", "data", and "roots". Nested lists/maps will be
converted into Reference objects. Note that if the data was not written
with <a class="crossref" href="../serialization/SimpleJsonFormat.html#storeRoundTripInfo">storeRoundTripInfo</a> true this will fail.</p>
<pre class="source">
Map&lt;String, dynamic&gt; read(data, Reader reader) {
 var result = new Map();
 // Check the case of having been written without additional data and
 // read as if it had been written with storeRoundTripData set.
 if (reader.selfDescribing &amp;&amp; !(data.containsKey(DATA))) {
   throw new SerializationException("Missing $DATA entry, "
       "may mean this was written and read with different values "
       "of selfDescribing.");
 }
 // If we are self-describing, we should have separate rule and data
 // sections. If not, we assume that we have just the data at the top level.
 var rules = reader.selfDescribing ? data[RULES] : null;
 var actualData = reader.selfDescribing ? data[DATA] : data;
 reader.readRules(rules);
 var ruleData = new List(reader.rules.length).map((x) =&gt; []).toList();
 var top = recursivelyFixUp(actualData, reader, ruleData);
 result["data"] = ruleData;
 result["roots"] = [top];
 return result;
}
</pre>
</div>
</div>
<div class="method"><h4 id="recursivelyFixUp">
<button class="show-code">Code</button>
<strong>recursivelyFixUp</strong>(input, <a href="../serialization/Reader.html">Reader</a> r, <a href="../dart_core/List.html">List</a> result) <a class="anchor-link" href="#recursivelyFixUp"
              title="Permalink to SimpleJsonFormat.recursivelyFixUp">#</a></h4>
<div class="doc">
<p>Convert nested references in <code>data</code> into <a class="crossref" href="../serialization/Reference.html">Reference</a> objects.</p>
<pre class="source">
recursivelyFixUp(input, Reader r, List result) {
 var data = input;
 if (isPrimitive(data)) {
   result[r._primitiveRule().number].add(data);
   return data;
 }
 var ruleNumber;
 // If we've added the rule number on as the last item in a list we have
 // to get rid of it or it will be interpreted as extra data. For a map
 // the library will be ok, but we need to get rid of the extra key before
 // the data is shown to the user, so we destructively modify.
 if (data is List) {
   ruleNumber = data.last;
   data = data.take(data.length - 1).toList();
 } else if (data is Map) {
   ruleNumber = data.remove(RULE);
 } else {
   throw new SerializationException("Invalid data format");
 }
 // Do not use map or other lazy operations for this. They do not play
 // well with a function that destructively modifies its arguments.
 var newData = mapValues(data, (each) =&gt; recursivelyFixUp(each, r, result));
 result[ruleNumber].add(newData);
 return new Reference(r, ruleNumber, result[ruleNumber].length - 1);
}
</pre>
</div>
</div>
</div>
        </div>
        <div class="clear"></div>
        </div>
        <div class="footer">
          <div>This page was generated at 2013-02-26 14:53:05.554</div>
<div>        <p>Except as otherwise <a href="http://code.google.com/policies.html#restrictions">noted</a>, the content of this
        page is licensed under the <a href="http://creativecommons.org/licenses/by/3.0/">Creative Commons Attribution
        3.0 License</a>, and code samples are licensed under the
        <a href="http://code.google.com/google_bsd_license.html">BSD License</a>.</p>
        <p><a href="http://www.dartlang.org/tos.html">Terms of Service</a> |
        <a href="http://www.google.com/intl/en/privacy/privacy-policy.html">Privacy Policy</a></p>
        </div>
        </div>
        <script async src="../client-static.js"></script>
        </body></html>
        
